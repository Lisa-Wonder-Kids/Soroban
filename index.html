<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Touch Soroban</title>

<style>
/* ───── layout & board ───── */
html,body{
  margin:0;padding:0;overflow:hidden;
  width:100vw;height:100dvh;display:flex;justify-content:center;align-items:center;
  background:#fff;touch-action:none;-webkit-user-select:none;user-select:none;
  overscroll-behavior:none;-webkit-tap-highlight-color:transparent;
}
#container{width:100%;height:100%;display:flex;justify-content:center;align-items:center;}

.soroban{
  display:flex;justify-content:center;align-items:center;
  background:#8B4513;padding:10px;border-radius:10px;
  box-shadow:0 0 15px rgba(0,0,0,.3);
}
.rod{
  position:relative;width:60px;height:250px;background:#D2B48C;
  border-radius:5px;display:flex;flex-direction:column;align-items:center;justify-content:space-between;
}
.rod-line{position:absolute;inset:0;width:4px;margin:auto;background:#000;z-index:0;}
.heaven{display:flex;flex-direction:column;justify-content:flex-end;align-items:center;height:12%;gap:5px;}
.gap-space{height:8%;}
.earth{display:flex;flex-direction:column;justify-content:flex-start;align-items:center;height:52%;margin-top:5px;}
.bar{position:absolute;top:30%;width:100%;height:8px;background:#000;z-index:2;}

/* ───── beads ───── */
.bead{
  width:50px;height:30px;border-radius:50%/40%;
  background:radial-gradient(circle at 30% 30%, #444, #111);
  box-shadow:inset -2px -2px 5px rgba(255,255,255,.2),
             inset  2px  2px 5px rgba(0,0,0,.4);
  will-change:transform;
  transition:transform .15s ease,background-color .15s ease;
  z-index:3;
}
.bead.dragging{                                          /* under finger = white */
  background:radial-gradient(circle at 30% 30%, #fff, #dcdcdc);
  box-shadow:inset -2px -2px 5px rgba(0,0,0,.05),
             inset  2px  2px 5px rgba(0,0,0,.25);
  transition:none;
}
.bead.active{                                            /* counted = yellow */
  background:radial-gradient(circle at 30% 30%, #ffd700, #ffbf00);
  box-shadow:inset -2px -2px 5px rgba(255,255,255,.4),
             inset  2px  2px 5px rgba(0,0,0,.3);
}

/* snap positions */
.bead.heaven.active{transform:translateY(150%);}   /* heaven slides DOWN */
.bead.earth.active {transform:translateY(-150%);}  /* earth slides UP */

/* ───── responsive tweaks ───── */
@media(max-width:768px){
  .soroban{flex-wrap:wrap;gap:5px;}
  .rod{width:60px;height:220px;}
  .bead{width:40px;height:25px;}
}
@media(max-width:480px){
  .soroban{gap:3px;}
  .rod{width:50px;height:200px;}
  .bead{width:35px;height:22px;}
}
/* rotate-device notice */
@media screen and (orientation:portrait){
  body::before{
    content:"Please rotate your device";
    position:fixed;inset:0;background:#000;color:#fff;font-size:2rem;
    display:flex;justify-content:center;align-items:center;z-index:9999;text-align:center;padding:1em;
  }
  #container{display:none;}
}
</style>
</head>
<body>
<div id="container">
  <div class="soroban">
    <!-- build 7 rods -->
    <template id="rod-tpl">
      <div class="rod">
        <div class="rod-line"></div>
        <div class="heaven"><div class="bead heaven"></div></div>
        <div class="gap-space"></div>
        <div class="earth">
          <div class="bead earth"></div><div class="bead earth"></div>
          <div class="bead earth"></div><div class="bead earth"></div>
        </div>
        <div class="bar"></div>
      </div>
    </template>
  </div>
</div>

<script>
/* =====================================================================
   Soroban – 30 % snap window, chained earth beads, wall collision, shake-reset
   ===================================================================== */
(() => {
  const SNAP_FRAC   = 0.30;  // ≤30 % from bar ⇒ ON, else OFF
  const SHAKE_G     = 16;    // accel to trigger reset (m/s²)
  const VIBRATE_MS  = 12;    // haptic per snap (0 = mute)
  const board       = document.querySelector('.soroban');

  /* build seven rods ---------------------------------------------- */
  const tpl = document.getElementById('rod-tpl').content;
  for (let i=0;i<7;i++) board.appendChild(tpl.cloneNode(true));

  /* per-pointer state --------------------------------------------- */
  const fingers = new Map();   // id → { group:[beads], startTops[], bounds, offsetY, heaven }

  board.style.touchAction='none';

  board.querySelectorAll('.bead').forEach(bead=>{
    bead.addEventListener('pointerdown',start,false);
    bead.addEventListener('pointermove',drag,false);
    bead.addEventListener('pointerup',end,false);
    bead.addEventListener('pointercancel',end,false);
  });

  /* ── pointerdown ──────────────────────────────────────────────── */
  function start(e){
    const primary  = e.currentTarget;
    const rod      = primary.closest('.rod');
    const rodRect  = rod.getBoundingClientRect();
    const barRect  = rod.querySelector('.bar').getBoundingClientRect();
    const beadRect = primary.getBoundingClientRect();
    const heaven   = primary.classList.contains('heaven');
    const beadH    = beadRect.height;

    /* primary bead’s travel limits */
    let topLimit, botLimit;

    if(heaven){
      topLimit = rodRect.top;
      botLimit = barRect.top - beadH;
    }else{
      topLimit = barRect.bottom;
      /* wall: next bead below (if any) */
      const earths   = [...rod.querySelectorAll('.bead.earth')];
      const idx      = earths.indexOf(primary);
      const below    = earths[idx+1];
      const belowTop = below ? below.getBoundingClientRect().top : (rodRect.bottom - beadH);
      botLimit = belowTop - beadH;        // can’t overlap lower bead
    }

    /* group for earth: bead + everything above; heaven: just itself */
    const group = heaven ? [primary]
                         : [...rod.querySelectorAll('.bead.earth')]
                           .slice(0, [...rod.querySelectorAll('.bead.earth')].indexOf(primary)+1);

    const tops = group.map(b=>b.getBoundingClientRect().top);

    group.forEach(b=>{ b.setPointerCapture(e.pointerId); b.classList.add('dragging'); });

    fingers.set(e.pointerId,{
      group,heaven,
      bounds:{top:topLimit,bot:botLimit},
      startTops:tops,
      offsetY:e.clientY - beadRect.top              // distance finger→bead top
    });
  }

  /* ── pointermove ──────────────────────────────────────────────── */
  function drag(e){
    const f = fingers.get(e.pointerId); if(!f) return;

    /* desired new top of the primary bead ------------------------ */
    let newTop = e.clientY - f.offsetY;
    newTop = Math.max(f.bounds.top, Math.min(newTop, f.bounds.bot));

    const delta = newTop - f.startTops[f.startTops.length-1];

    /* collision check: ensure upper beads don’t cross the bar ------ */
    if(!f.heaven){
      const topBeadStart = f.startTops[0];
      if(topBeadStart + delta < f.bounds.top){
        /* clamp delta so top bead stops at bar */
        const maxUpDelta = f.bounds.top - topBeadStart;
        newTop = f.startTops[f.startTops.length-1] + maxUpDelta;
      }
    }

    /* apply transform to every bead in the chain ------------------ */
    f.group.forEach((b,i)=>{
      b.style.transform = `translateY(${newTop - f.startTops[f.startTops.length-1]}px)`;
    });
  }

  /* ── pointerup / cancel ───────────────────────────────────────── */
  function end(e){
    const f = fingers.get(e.pointerId); if(!f) return;

    const primary = f.group[f.group.length-1];
    const beadRect= primary.getBoundingClientRect();
    const travel  = f.bounds.bot - f.bounds.top;           // full range

    let frac;                                             // 0 (at bar) → 1 (at rest)
    if(f.heaven){
      frac = (beadRect.top - f.bounds.top) / travel;      // heaven moves down
    }else{
      frac = (beadRect.top - f.bounds.top) / travel;      // earth moves up, same formula
    }

    const shouldBeActive = f.heaven ? (frac >= 1 - SNAP_FRAC)   // ≥70 % toward bar
                                    : (frac <= SNAP_FRAC);      // ≤30 % from bar

    /* snap every bead in the dragged group ------------------------ */
    f.group.forEach(b=>{
      b.classList.toggle('active', shouldBeActive);
      b.classList.remove('dragging');
      b.style.transform='';
      b.releasePointerCapture(e.pointerId);
    });

    if(VIBRATE_MS) navigator.vibrate(VIBRATE_MS);
    fingers.delete(e.pointerId);
  }

  /* ── shake-to-reset ───────────────────────────────────────────── */
  if('DeviceMotionEvent' in window){
    let last = 0;
    addEventListener('devicemotion', ev=>{
      const {x,y,z} = ev.accelerationIncludingGravity;
      if(Math.hypot(x,y,z) > SHAKE_G && performance.now() - last > 750){
        board.querySelectorAll('.bead.active').forEach(b=>b.classList.remove('active'));
        if(VIBRATE_MS) navigator.vibrate([0,40,40,40]);
        last = performance.now();
      }
    });
  }
})();
</script>
</body>
</html>
