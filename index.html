<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport"
         content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
      <title>Touch Soroban</title>
      <style>
         /* ───────── layout & board ───────── */
         html,body{
         margin:0;
        padding:0;overflow:hidden;
         width:100vw;height:100dvh;display:flex;justify-content:center;align-items:center;
         background:#fff;touch-action:none;-webkit-user-select:none;user-select:none;
         overscroll-behavior:none;-webkit-tap-highlight-color:transparent;
         }
         #container{
width:100%;
height:100%;
display:flex;
justify-content:center;
align-items:center;
}
         .soroban{
         display:flex;
        justify-content:center;
        align-items:center;
         background:#9999ff;
         padding:10px;
         border-radius:5px;
         box-shadow:0 0 15px rgba(0,0,0,.3);
         gap: 10px; /* ← NEW: space between rods */
         }

         .rod{
         position:relative;
         width:90px;
         height:270px;
         background:#8080ff;
         border-radius:5px;
        display:flex;
       flex-direction:column;
       align-items:center;
justify-content:space-between;
         }
         .rod-line{
        position:absolute;
        inset:0;
        width:4px;
        margin:auto;
       background:#6666ff;
       z-index:0;}

         .heaven{
display:flex;
flex-direction:column;
justify-content:flex-end;align-
     items:center;
height:12%;
gap:5px;}

         .gap-space{
height:8%;
}

         .earth{
display:flex;
flex-direction:column;
justify-content:flex-start;
align-items:center;
height:52%;
margin-top:5px;       
    gap: 5px;
 }

         .bar{
        position:absolute;
top:30%;
        width:100%;
        height:8px;
        background:#6666ff;
        z-index:1;
        }
         /* ───────── beads ───────── */
         .bead{
         width: 60px;
      height: 40px;
      background: linear-gradient(to bottom, #000080, #000033); /* You can customize the       color */
      clip-path: polygon(
       25% 0%, 75% 0%,
       100% 50%,
       75% 100%, 25% 100%,
       0% 50%
       );
      box-shadow: inset -1px -1px 4px rgba(255, 255, 255, 0.3),
              inset 1px 1px 4px rgba(0, 0, 0, 0.3);
         will-change:transform;
         transition:transform .15s ease,
         background-color .15s ease;
         z-index:2;
         }

         /* dragging = white */

         .bead.dragging{
         background:radial-gradient(circle at 30% 30%, #fff, #dcdcdc);
         box-shadow:inset -2px -2px 5px rgba(0,0,0,.05),
         inset  2px  2px 5px rgba(0,0,0,.25);
         transition:none;
         }
         /* active = yellow */
         .bead.active{
         background:radial-gradient(circle at 30% 30%, #ffd700, #ffbf00);
         box-shadow:inset -2px -2px 5px rgba(255,255,255,.4),
         inset  2px  2px 5px rgba(0,0,0,.3);
         }
         /* park positions */
         .bead.heaven.active{
transform:translateY(150%);
}

         .bead.earth.active {
          transform:translateY(-150%);
         }

         /* ───────── responsive tweaks ───────── */
         @media(max-width:768px){
         .soroban{
flex-wrap:wrap;
gap:8px;}

         .rod{
width:60px;
height:250px;
}

         .bead{
width:40px;
height:25px;}
         }
         @media(max-width:480px){
         .soroban{gap:3px;}
         .rod{width:50px;height:200px;}
         .bead{width:35px;height:22px;}
         }
         /* rotate notice */
         @media screen and (orientation:portrait){
         body::before{
         content:"Please rotate your device";
         position:fixed;inset:0;background:#000;color:#fff;font-size:2rem;
         display:flex;justify-content:center;align-items:center;z-index:9999;text-align:center;padding:1em;
         }
         #container{display:none;}
         }
      </style>
   </head>
   <body>
      <div id="container">
         <div class="soroban">
            <!-- build 7 rods -->
            <template id="rod-tpl">
               <div class="rod">
                  <div class="rod-line"></div>
                  <div class="heaven">
                     <div class="bead heaven"></div>
                  </div>
                  <div class="gap-space"></div>
                  <div class="earth">
                     <div class="bead earth"></div>
                     <div class="bead earth"></div>
                     <div class="bead earth"></div>
                     <div class="bead earth"></div>
                  </div>
                  <div class="bar"></div>
               </div>
            </template>
         </div>
      </div>
      <script>
         /* =====================================================================
            Soroban – free-drag, snap-nearest (no side-sweep), shake-reset
            ===================================================================== */
         (() => {
           const SHAKE_G    = 16;   // ≈1.6 g to clear the board
           const VIBRATE_MS = 12;   // haptic length (0 = off)
         
           /* build 7 rods from template ------------------------------------ */
           const board = document.querySelector('.soroban');
           const tpl   = document.getElementById('rod-tpl').content;
           for (let i = 0; i < 7; i++) board.appendChild(tpl.cloneNode(true));
         
           /* per-pointer state -------------------------------------------- */
           const fingers = new Map(); // id → { bead, heaven, bounds, startTop, offsetY }
         
           board.style.touchAction = 'none';
         
           board.querySelectorAll('.bead').forEach(bead => {
             bead.addEventListener('pointerdown',  start, false);
             bead.addEventListener('pointermove',  drag , false);
             bead.addEventListener('pointerup',    end  , false);
             bead.addEventListener('pointercancel',end  , false);
           });
         
           /* pointerdown --------------------------------------------------- */
           function start (e) {
             const bead     = e.currentTarget;
             const rod      = bead.closest('.rod');
             const rodRect  = rod.getBoundingClientRect();
             const barRect  = rod.querySelector('.bar').getBoundingClientRect();
             const beadRect = bead.getBoundingClientRect();
             const heaven   = bead.classList.contains('heaven');
         
             /* vertical travel limits for this bead */
             const bounds = heaven
               ? { top: rodRect.top,                    bot: barRect.top - beadRect.height }  // heaven slides DOWN
               : { top: barRect.bottom,                 bot: rodRect.bottom - beadRect.height }; // earth slides UP
         
             bead.setPointerCapture(e.pointerId);
             bead.classList.add('dragging');
         
             fingers.set(e.pointerId, {
               bead, heaven, bounds,
               startTop : beadRect.top,
               offsetY  : e.clientY - beadRect.top
             });
           }
         
           /* pointermove --------------------------------------------------- */
           function drag (e) {
             const f = fingers.get(e.pointerId); if (!f) return;
         
             let newTop = e.clientY - f.offsetY;                             // raw finger position
             newTop = Math.max(f.bounds.top, Math.min(newTop, f.bounds.bot)); // clamp into rod
            f.bead.style.transform = `translateY(${newTop - f.startTop}px)`; // follow finger
           }
         
           /* pointerup / cancel ------------------------------------------- */
           function end (e) {
             const f = fingers.get(e.pointerId); if (!f) return;
         
             /* where is the bead when you let go? */
             const beadTop = f.bead.getBoundingClientRect().top;
         
             /* distances to ON and OFF anchor positions */
             const activePos   = f.heaven ? f.bounds.bot : f.bounds.top;  // heaven ON = lower, earth ON = upper
             const inactivePos = f.heaven ? f.bounds.top : f.bounds.bot;
         
             const makeActive = Math.abs(beadTop - activePos) < Math.abs(beadTop - inactivePos);
         
             f.bead.classList.toggle('active', makeActive);                // yellow if ON
             if (VIBRATE_MS) navigator.vibrate(VIBRATE_MS);
         
             /* tidy up */
             f.bead.classList.remove('dragging');
             f.bead.style.transform = '';          // let CSS .active rule position it
             f.bead.releasePointerCapture(e.pointerId);
             fingers.delete(e.pointerId);
           }
         
           /* shake-to-reset ------------------------------------------------ */
           if ('DeviceMotionEvent' in window) {
             let last = 0;
             addEventListener('devicemotion', ev => {
               const { x, y, z } = ev.accelerationIncludingGravity;
               if (Math.hypot(x, y, z) > SHAKE_G && performance.now() - last > 750) {
                 board.querySelectorAll('.bead.active').forEach(b => b.classList.remove('active'));
                 if (VIBRATE_MS) navigator.vibrate([0,40,40,40]);
                 last = performance.now();
               }
             });
           }
         })();
      </script>
   </body>
</html>
